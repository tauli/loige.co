{"data":{"site":{"siteMetadata":{"title":"Luciano Mammino \"Loige\" - Web developer, entrepreneur, fighter, butterfly maker!","author":"Luciano Mammino","siteUrl":"https://loige.co/","twitterProfile":"loige","disqusShortName":"loige"}},"markdownRemark":{"id":"8473aa97-a949-5d98-8ea2-d134fcecd34e","timeToRead":3,"headings":[],"html":"<p>Recently I had the need to run a twig template that uses the <code class=\"language-text\">trans</code> filter on my frontend using <a href=\"http://jmsyst.com/libs/twig.js\">twig.js</a>, a pure JavaScript port of twig written by the good <a href=\"http://jmsyst.com/\">Johannes Schmitt</a>.\nThe JavaScript version does not handle all the functionalities offered by the original PHP version (even if it goes pretty close) and in particular it does not natively handle the <code class=\"language-text\">trans</code> filter.</p>\n<p>So, at first, I got a JavaScript runtime exception on my page when trying to use the template.\nLuckily enough the JavaScript version of twig is extensible like the PHP one and it is very easy to add new filters and functions.</p>\n<p>In my specific case I had a Symfony application where I was already using <a href=\"https://github.com/willdurand/BazingaJsTranslationBundle\">BazingaJsTranslationBundle</a> to manage dynamic translations on the frontend. As I discovered the twig.js extensibility, it was very easy to start building a twig.js extension by using the <code class=\"language-text\">Translator</code> JavaScript object offered by the Bazinga bundle.</p>\n<p><strong>Note</strong>: I will not go into the details about how to install twig.js and BazingaJsTranslationBundle in a Symfony application. You can find all the needed informations on their websites/github pages.</p>\n<p>In my first attempt I wrote something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Twig<span class=\"token punctuation\">.</span><span class=\"token function\">setFilter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'trans'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> domain<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Translator<span class=\"token punctuation\">.</span><span class=\"token function\">trans</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> domain<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>That seemed to work pretty good until I started to use translation strings with parameters. Parameters were not replaced with their respective values!\nThe problem laid in a subtle differece on how the BazingaJsTranslationBundle and the standard twig handle parameters. Let’s see a simple example.</p>\n<p>Suppose we have the string <code class=\"language-text\">hello %name%</code>. With twig we expect to do something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"jinja+html\"><pre class=\"language-jinja+html\"><code class=\"language-jinja+html\">{{ &#39;hello %name%&#39;|trans({ &#39;%name%&#39; : &#39;Alice&#39; }) }}</code></pre></div>\n<p>Note the <code class=\"language-text\">%</code> delimiters around the parameter name.</p>\n<p>The <code class=\"language-text\">Translator.trans</code> method expects an hash map without parameter delimiters in it. So we would have to do something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Translator<span class=\"token punctuation\">.</span><span class=\"token function\">trans</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello %name%\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token string\">'name'</span> <span class=\"token punctuation\">;</span> <span class=\"token string\">'Alice'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Note that there’s no <code class=\"language-text\">%</code> delimiter this time.\nThe <code class=\"language-text\">Translator.trans</code> method manages the detection of parameters by itself and you can also decide to customize the delimiters by setting the values: <code class=\"language-text\">Translator.placeHolderPrefix</code> and <code class=\"language-text\">Translator.placeHolderSuffix</code>.\nObviously I suggest you to be consistent and use the same placeholders you use with PHP (especially if you need to share templates and translations from the backend to the frontend).</p>\n<p>So my final solution was the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Twig<span class=\"token punctuation\">.</span><span class=\"token function\">setFilter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'trans'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> domain<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  params <span class=\"token operator\">=</span> params <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// normalizes params (removes placeholder prefixes and suffixes)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> key <span class=\"token keyword\">in</span> params<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      params<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n      key<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> Translator<span class=\"token punctuation\">.</span>placeHolderPrefix <span class=\"token operator\">&amp;&amp;</span>\n      key<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> Translator<span class=\"token punctuation\">.</span>placeHolderSuffix\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      params<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">.</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> params<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">delete</span> params<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> Translator<span class=\"token punctuation\">.</span><span class=\"token function\">trans</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> params<span class=\"token punctuation\">,</span> domain<span class=\"token punctuation\">,</span> locale<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This way it automatically normalizes parameters for the <code class=\"language-text\">Translator</code> object (by removing any delimiter from parameter keys) and I have a consistent behavior between twig and twig.js.\nMy normalization approach is very rough and you can surely find a better approach (maybe using a regex).\nLet me know if you do it ;)</p>\n<p>Obviously you can also avoid the normalization and keep the responsibility to pass the parameters hash map in the way the <code class=\"language-text\">Translator</code> object expects it (without delimiters). In this case you can stick to my first implementation.</p>\n<p>That’s all. See ya ;)</p>","frontmatter":{"title":"Integrating Twig.js and BazingaJsTranslationBundle","slug":"integrating-twig-js-and-bazingajstranslationbundle","author":"Luciano Mammino","tags":["php","symfony","javascript","translation","twig"],"date":"February 28, 2014","header_img":{"publicURL":"/static/integrating-twig-js-and-bazingajstranslationbundle-c55fd49a6826ee1cf2f5094c5c5970d2.png"}}}},"pageContext":{"slug":"integrating-twig-js-and-bazingajstranslationbundle","width":440,"height":220,"type":"twitter"}}
{"data":{"site":{"siteMetadata":{"title":"Luciano Mammino \"Loige\" - Web developer, entrepreneur, fighter, butterfly maker!","author":"Luciano Mammino","siteUrl":"https://loige.co/","twitterProfile":"loige","disqusShortName":"loige"}},"markdownRemark":{"id":"19def87a-9989-5a8c-937f-00e60168ec8d","excerpt":"One of the things I like most of the Symfony framework is its  Http Kernel component . Not only it does offer a very straightforward…","timeToRead":5,"headings":[{"value":"The Kernel Response event","depth":2},{"value":"Example 1. Add custom Http headers to notify remaining api calls","depth":3},{"value":"Example 2. Create a cookie to track referrals","depth":3},{"value":"Conclusion","depth":2}],"html":"<p>One of the things I like most of the Symfony framework is its <a href=\"https://packagist.org/packages/symfony/http-kernel\">Http Kernel component</a>. Not only it does offer a very straightforward abstraction to handle requests and responses in an object-oriented way but it also allows you to interact with the whole response generation process through <a href=\"http://symfony.com/doc/current/components/http_kernel/introduction.html#creating-an-event-listener\">events</a>.</p>\n<p><a href=\"http://symfony.com/doc/current/components/http_kernel/introduction.html\">\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 690px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABuklEQVQoz3VSTW/TQBD17+LML+J3IHFAKhcQAlXcOCBagagqxKGHiBY1ok0RDVVIaie146SJ93NmZ5ZZm0AA8bzyeL1vPnbeZH4DY7VxGhHCFkieFriB30LWGQCYNzfT27HxiolJnARiaRMkBOEYY1AMbDnLLmA6A/SSQ6zSShmljXLeQluL5Gz90TovX8nV+aw9ksDIFFiSxpRQthQSm2Jot9Sdaot5pYwDQvIOMo8WSSKydhhD5HVkx4EjUGSKUUW2UaBtCgVASw2ILC4eXLZ7/ODt4Nmbo+LxYX65V+zd6V/sXL/q5Tv7k/Pe7N3ds969b5P56uHLy6OzejjVj15PP09GL07u7w92s0H5cbQ8/z5z/bFZXZkvT4r6U3NV+dORW5Tu6/P8+mBhPL4/rcelLxbNYX9erZv+zYeL8iSLHNslt8XInEqM3fsP5NMZUfTBOFx1FGlC5kG6lwSUqyRVIRB2AicgEAeywE8PquPhQomgthG3emXqW5Wk+im/NJyZ/oH8krDDAuZrIUgO4Ydyaaql+T0k2mon7ReZhRD+XjFKSVKkMBxskP2aNW2Sc/gPUmEpDGyP5w9w6qv4jYi7gQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <picture>\n        <source\n          srcset=\"/static/symfony-http-kernel-component-overview-scheme-7cc916d92fa24000093d9ecdcc4ad955-72331.webp 256w,\n/static/symfony-http-kernel-component-overview-scheme-7cc916d92fa24000093d9ecdcc4ad955-35a16.webp 512w,\n/static/symfony-http-kernel-component-overview-scheme-7cc916d92fa24000093d9ecdcc4ad955-b96dd.webp 690w\"\n          sizes=\"(max-width: 690px) 100vw, 690px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/symfony-http-kernel-component-overview-scheme-7cc916d92fa24000093d9ecdcc4ad955-fb9dc.png 256w,\n/static/symfony-http-kernel-component-overview-scheme-7cc916d92fa24000093d9ecdcc4ad955-a6f44.png 512w,\n/static/symfony-http-kernel-component-overview-scheme-7cc916d92fa24000093d9ecdcc4ad955-45e91.png 690w\"\n          sizes=\"(max-width: 690px) 100vw, 690px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n          src=\"/static/symfony-http-kernel-component-overview-scheme-7cc916d92fa24000093d9ecdcc4ad955-45e91.png\"\n          alt=\"Symfony Http Kernel component overview\"\n          title=\"\"\n          src=\"/static/symfony-http-kernel-component-overview-scheme-7cc916d92fa24000093d9ecdcc4ad955-45e91.png\"\n        />\n      </picture>\n      </span>\n  </span>\n  </a></p>\n<p>This approach is very convenient and flexible and in fact the Http Kernel component is the foundation of the Symfony framework but also of several other famous frameworks (Silex, Laravel) and CMSes (Drupal, BackBee CMS).</p>\n<h2 id=\"the-kernel-response-event\"><a href=\"#the-kernel-response-event\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Kernel Response event</h2>\n<p>One event that I’ve been using a lot lately is the <a href=\"http://api.symfony.com/master/Symfony/Component/HttpKernel/Event/FilterResponseEvent.html\">Kernel Response event</a> which allows you to edit the response after it has been generated.</p>\n<p>Thanks to this event you can easily modify the response object (cookies, headers, content, etc.) before it gets sent out to the user without affecting the specific logic of every controller thus avoiding code cluttering and duplication.</p>\n<p>I will present two different real case scenarios to show how useful (and simple) it is.</p>\n<h3 id=\"example-1-add-custom-http-headers-to-notify-remaining-api-calls\"><a href=\"#example-1-add-custom-http-headers-to-notify-remaining-api-calls\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example 1. Add custom Http headers to notify remaining api calls</h3>\n<p>Let’s suppose we developed a wonderful rate limited api and now we want to add some custom headers to notify the user about how much he is using the API.\nIt seems a good idea to copy the approach adopted by the GitHub APIs and add three custome headers: <code class=\"language-text\">X-RateLimit-Limit</code> (maximum number of requests per period), <code class=\"language-text\">X-RateLimit-Remaining</code> (remaining requests in the current period) and <code class=\"language-text\">X-RateLimit-Reset</code> (the timestamp on which the current period ends).</p>\n<p>As I don’t want to implement a fully working solution here let’s assume we have already written a rate limit checker service registered as <code class=\"language-text\">rate_limit_checker</code> that implements the following interface:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\">\n      <pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">RateLimitCheckerInterface</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getRateLimit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getRateLimitRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getRateLimitReset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>Let’s now write our <code class=\"language-text\">RateLimitHeadersListener</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\">\n      <pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">use</span> <span class=\"token package\">Symfony<span class=\"token punctuation\">\\</span>Component<span class=\"token punctuation\">\\</span>HttpKernel<span class=\"token punctuation\">\\</span>Event<span class=\"token punctuation\">\\</span>FilterResponseEvent</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RateLimitHeadersListener</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token variable\">$rateLimitChecker</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span>\n    \tRateLimitCheckerInterface <span class=\"token variable\">$rateLimitChecker</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    \t<span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">rateLimitChecker</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$rateLimitChecker</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onKernelResponse</span><span class=\"token punctuation\">(</span>FilterResponseEvent <span class=\"token variable\">$event</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$headers</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">headers</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$headers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n        \t<span class=\"token single-quoted-string string\">'X-RateLimit-Limit'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">rateLimitChecker</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRateLimit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$headers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n        \t<span class=\"token single-quoted-string string\">'X-RateLimit-Remaining'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">rateLimitChecker</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRateLimitRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$headers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\n        \t<span class=\"token single-quoted-string string\">'X-RateLimit-Reset'</span><span class=\"token punctuation\">,</span>\n            <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">rateLimitChecker</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRateLimitReset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>Now we need to register the listener as a tagged service:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\">\n      <pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">#services.yml</span>\n<span class=\"token key atrule\">rate_limit_listener</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">class</span><span class=\"token punctuation\">:</span> RateLimitHeadersListener\n  <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@rate_limit_checker'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kernel.event_listener<span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span> kernel.response<span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> onKernelResponse<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>That’s it. Really straightforward, isn’t it?\nShould be clear now that, by using this event based approach, we don’t have to touch the logic of every single controller.</p>\n<p>Take a small break and get ready to jump to another example.</p>\n<h3 id=\"example-2-create-a-cookie-to-track-referrals\"><a href=\"#example-2-create-a-cookie-to-track-referrals\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Example 2. Create a cookie to track referrals</h3>\n<p>Well, now imagine that we have to build an affiliate program based on referral links (<a href=\"https://sbaam.com/affiliates?_r=9oj\">I did it</a> lately).</p>\n<p>The general idea is that our affiliates are identified by an ID that they can attach to every url of the website as query parameter. This way every URL of our website can be an entry point for our visitors and our affiliates are free to promote the content that is more relevant for them.\nDoing so we need to verify every possibile request to check for the referrral parameter and keep track of the whole session of the visitor (or even better monitor him for a given amount of days) to see if his visits converts into some kind of action for which we have to reward the affiliate.\nTo write a more formal specification we have to:</p>\n<ol>\n<li>Allow any of our affiliates to share links with a special referral code as query parameter: <code class=\"language-text\">?_ref=&lt;REF_ID&gt;</code> (where <code class=\"language-text\">REF_ID</code> is the unique id of the affiliate).</li>\n<li>Intercept visitor referred by affiliates through the referral parameter and identify the referral</li>\n<li>Create a cookie to track the referred visitor for 30 days</li>\n</ol>\n<p>Again we can use the Kernel Response Event and create a dedicated listener for this task. Before doing so suppose we have already developed a mechanism to store our affiliates and that we have coded a <code class=\"language-text\">affiliate_repository</code> service which implementats of the following interface:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\">\n      <pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">AffiliateRepositoryInterface</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">findOneById</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>Now let’s write our listener to intercept clicks on referral links:</p>\n<div class=\"gatsby-highlight\" data-language=\"php\">\n      <pre class=\"language-php\"><code class=\"language-php\"><span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AffiliateLinkClickListener</span>\n<span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">private</span> <span class=\"token variable\">$affiliateRepository</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span>\n    \tAffiliateRepositoryInterface <span class=\"token variable\">$affiliateRepository</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    \t<span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">affiliateRepository</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$affiliateRepository</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onKernelResponse</span><span class=\"token punctuation\">(</span>FilterResponseEvent <span class=\"token variable\">$event</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n    \t<span class=\"token variable\">$request</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$response</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$event</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">getResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 1.</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">query</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">has</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_ref'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        \t<span class=\"token variable\">$affiliateId</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">query</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_ref'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// 2.</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span> <span class=\"token operator\">!==</span> <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">affiliateRepository</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">findOneById</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$affiliateId</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            \t<span class=\"token comment\">// 3.</span>\n                <span class=\"token variable\">$cookie</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cookie</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'_ref'</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$affiliateId</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token punctuation\">\\</span>DateTime</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'+30 days'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token variable\">$response</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">headers</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">setCookie</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$cookie</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>The code is pretty simple here:</p>\n<ol>\n<li>We check if there’s a <code class=\"language-text\">_ref</code> parameter in the current request</li>\n<li>If so we check if we have an affiliate with the id found in the <code class=\"language-text\">_ref</code> parameter</li>\n<li>If that’s the case we create a cookie that will allow us to keep track of the referral for 30 days.</li>\n</ol>\n<p>Obviously don’t forget to register the listener as a tagged service:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\">\n      <pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\">#services.yml</span>\n<span class=\"token key atrule\">affiliate_link_click_listener</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">class</span><span class=\"token punctuation\">:</span> AffiliateLinkClickListener\n  <span class=\"token key atrule\">arguments</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@affiliate_repository'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> kernel.event_listener<span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">event</span><span class=\"token punctuation\">:</span> kernel.response<span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">method</span><span class=\"token punctuation\">:</span> onKernelResponse<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span></code></pre>\n      </div>\n<p>As I said, this mechanisms allows you to track the reference but you also need to track any conversion and check the cookie to see if it has been generated by some affiliate.</p>\n<h2 id=\"conclusion\"><a href=\"#conclusion\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>As in every tutorial, bear in mind that the code is just a sample to give you a general idea about an approach you can follow to solve some generic problem. You need to adapt it to your use case and consider relevant factors such as security, testing, etc.</p>\n<p>Let me know what you think with a comment (<a href=\"#disqus_thread\">comments</a>) and feel free to suggest other real-life use cases for the Kernel Response Event.</p>\n<p>Thanks!</p>\n<p>PS: Huge thanks to <a href=\"http://twitter.com/AxelLessio\">@AxelLessio</a> and <a href=\"http://twitter.com/javiereguiluz\">@JavierEguiluz</a> for taking the time to review my very bad english ;)</p>","frontmatter":{"title":"Symfony, edit the Response globally using the Kernel Response event","meta_description":null,"slug":"symfony-edit-the-response-globally-using-the-kernel-response-event","author":"Luciano Mammino","tags":["php","symfony","http"],"date":"February 21, 2015","dateISO":"2015-02-21T01:12:00.000Z","header_img":{"publicURL":"/static/symfony-edit-the-response-globally-using-the-kernel-response-event-6ac1c6c77e2d54cb09869c500106341d.jpg"},"fb_img":{"publicURL":"/static/symfony-edit-the-response-globally-using-the-kernel-response-event-fb-31dc3330bb93f7f6079ff9101c4acbf1.png"},"tw_img":{"publicURL":"/static/symfony-edit-the-response-globally-using-the-kernel-response-event-tw-364e3cf64789500391d87439a8b61d9f.png"}}}},"pageContext":{"tags":["php","symfony","http"],"slug":"symfony-edit-the-response-globally-using-the-kernel-response-event","previous":{"timeToRead":5,"excerpt":"What a hell of 3 months! During the last 3 months I haven’t got a single minute to take care of this blog. I started a new adventure and moved to Ireland to attend the Bank of Ireland Accelerator Programme in Cork with my startup  Sbaam . There I spent 3 incredible months with a huge amount of lessons learned about  startups  and  entrepreneurship . I want to share with you 5 of the best quotes I heard from the mentors and explain what I learned from them. Consider this is my first “non technical” post with…","fields":{"slug":"5-lessons-learned-at-the-bank-of-ireland-accelerator"},"frontmatter":{"date":"22 December, 2014","title":"5 lessons learned at the Bank of Ireland Accelerator","tags":["startup","entrepreneurship"],"header_img":{"publicURL":"/static/boi-1-3eaf28c6d7c5d4e7a3a5c96c15d9c8b6.png"}}},"next":{"timeToRead":10,"excerpt":"Lumen  is a new  Php  micro-framework developed by  Taylor Otwell , the same author of the famous  Laravel  framework. I wanted to give it a try and I am here to share my experimentations. I am not an expert of Lumen (yet), but I think one of the best characteristics of this framework is that it makes really really easy to bootstrap a new project.\nSo to prove this, we will now build a fully functional app backed by a MySql database in less than 30 minutes. Are you ready to start? A motivational quote…","fields":{"slug":"developing-a-web-application-with-lumen-and-mysql"},"frontmatter":{"date":"18 April, 2015","title":"Developing a web application with Lumen and MySql","tags":["php","mysql","lumen","laravel"],"header_img":{"publicURL":"/static/developing-a-web-application-with-lumen-de4e7c62eaaa7504bae0f67a967ee639.jpg"}}},"similar":[{"slug":"transparent-pixel-response-with-symfony-how-to-track-email-opening","title":"Transparent pixel response with Symfony, how to track email opening","publishedAt":"13 June, 2014","score":3},{"slug":"6-rules-of-thumb-to-build-blazing-fast-web-applications","title":"6 Rules of thumb to build blazing fast web server applications","publishedAt":"25 July, 2015","score":2},{"slug":"write-a-console-application-using-symfony-and-pimple","title":"Write a console application using Symfony and Pimple","publishedAt":"15 March, 2014","score":2},{"slug":"integrating-twig-js-and-bazingajstranslationbundle","title":"Integrating Twig.js and BazingaJsTranslationBundle","publishedAt":"28 February, 2014","score":2},{"slug":"symfony-security-authentication-made-simple","title":"Symfony security: authentication made simple (well, maybe!)","publishedAt":"14 February, 2014","score":2}]}}
{"data":{"site":{"siteMetadata":{"title":"Luciano Mammino \"Loige\" - Web developer, entrepreneur, fighter, butterfly maker!","author":"Luciano Mammino","siteUrl":"https://loige.co/","twitterProfile":"loige","disqusShortName":"loige"}},"markdownRemark":{"id":"ad3097e6-4e3c-5625-94e6-0e52f494db97","excerpt":"Recently at  Planet 9 Energy , I had to setup a VPN access to secure some of our internal services. One of the requirements was to make the‚Ä¶","timeToRead":18,"headings":[{"value":"Installing Certbot","depth":2},{"value":"Generating a certificate with Certbot","depth":2},{"value":"A complete example infrastructure with Terraform","depth":2},{"value":"VPC & Subnet","depth":3},{"value":"The key pair","depth":3},{"value":"Security group","depth":3},{"value":"Subdomain","depth":3},{"value":"EC2 instance","depth":3},{"value":"Trigger-based provisioning with ","depth":3},{"value":"The provider configuration and the variable file","depth":3},{"value":"Plan, apply and destroy","depth":3},{"value":"Some extra tips","depth":2},{"value":"Let‚Äôs Encrypt throttling","depth":3},{"value":"Certificate expiry and renewal","depth":3},{"value":"Intermittent failures during the provisioning","depth":3},{"value":"Wrapping up","depth":2}],"html":"<p>Recently at <a href=\"https://planet9energy.com\">Planet 9 Energy</a>, I had to setup a VPN access to secure some of our internal services. One of the requirements was to make the provisioning easy to reproduce over multiple environments, so we ended up playing a bit with Terraform, while obviously adopting OpenVPN for the VPN server.</p>\n<p>Another important requirement was to expose the OpenVPN web interface (also called Access Server) using an SSL, which I was expecting to be one of the most challenging things to automate, instead, it turned out to be very easy using <a href=\"https://letsencrypt.org\">Let‚Äôs Encrypt</a> and <a href=\"https://certbot.eff.org\">Certbot</a>.</p>\n<p>In this article, I will illustrate you how to use Certbot to automate the creation of SSL certificates (for OpenVPN as a practical example) and how to integrate this process in AWS-land using Terraform.</p>\n<h2 id=\"installing-certbot\"><a href=\"#installing-certbot\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Installing Certbot</h2>\n<p>Installing Certbot on a Ubuntu (Xenial) machine is as easy as:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> -y <span class=\"token function\">install</span> software-properties-common\n<span class=\"token function\">sudo</span> add-apt-repository -y ppa:certbot/certbot\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> -y update\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> -y <span class=\"token function\">install</span> certbot</code></pre></div>\n<p>This code uses the <code class=\"language-text\">certbot</code> PPA to install the executable.</p>\n<p>A Little tip (in case you don‚Äôt know it yet): <code class=\"language-text\">-y</code> allows the install to be non-interactive and to proceed without the need to confirm every operation from the keyboard.</p>\n<p>From this moment on you can use the <code class=\"language-text\">certbot</code> executable.</p>\n<p>If you want to have an idea of its capabilities you can simply run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">certbot --help</code></pre></div>\n<p>The outcome will be something like this:</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; ; max-width: 575px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 132.8695652173913%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAbCAIAAADzvTiPAAAACXBIWXMAAAsSAAALEgHS3X78AAADvklEQVQ4y32UCXeqSBCFFUURV1DZEZEdIYqap+Zkck7ezP//TfOx5GW2MxXSQkN337p1b/UcxwnDaEd4O3fnGoZhWdZytTRNs/ev6Dfx/TydzviaNUEQZFnmuq5lM2ErirLzvIN/4GZPeN5oJP5zM1VVdV1fLBaGYWpbTVmt1uv1YrHcbremaRm6MZvNLNvWNV0aj+fzOd+PRqNu8el0zrPsx/3+eDxemnh//+35fJZleblciqK4Xq/H45HHIAz5+HK9+ge/w65p+nQ2dZw6W9txSDVJkmOeG4ZuWib4NU0TiH5fENrf/mAw6DJ33J1lmZ7nue5OXW/I2WADw/T2vmUa/YYkvh4Oh4ySNOb65mw8HreYOYFsP3//4/TyAsj7457nJJTmxyI/Hmv8t9ulqqgOGwGhW5/l+eFw6Pf6Q1E8nU5BE6yMkzSKoqq6kAjlPJ3PdUG9HR+TY71SFEXbdqIwhHAwed7+4PvebmfbdcXg3Nt7a1VdKiugUQVN11erVXfycrmiijBJtixgMZfThO/7WZZTZ2EgzOeLqTwlhL+KZLPZPt/ePj4+wAaq2+1GtrfXH9SJ+ff3d4SHENAfF/qh1NKEkCGrJ01kvuNwNmKOxKIoBAjJpVmaJCmvwiiM4hgWgJZmWXW5wORysegJgwE51Nv0eoIwaDlnbBRmQoQojigUB9ag5SkH8DuZSDVsSZpQ4c1mg/qoAXqK60OOSI1RN/StprmOy17rtdq6ozVIzRlswxDEthoCJLLy/b2qKIAELVuzUdQEdQEOuAzT0rabXhBE8AxVhyBwXac1XSsD4cuAv0YsITXRvuzJslwWZZZnlH4xnzeERUEQnquqFnlxxKcYPY4TZAftnEwVO2OxQXW57nZuK5jH45mmaRzXekJtesMcB0AKaBH43/zMFEyiLUVR+aM31KTKcj05Gvf+P0zL/vz8iYGRq6oqj+fb+VwVRfm4319fX+MkTpOUvA4HX57Iq9WyK1LXlgSB6iMLoS8A+/RyQiG4PwyDJE1bnquqwl5l+YL+SOobvKqujTrM5XJJx4HJVgbiUEQ53EiNiUd1jPnnLcb+0nZT/bqN2A5k/mdqg6+gOm0/6V6wmSxPKACqZIuJJMVJUjRBzmVR4C1SQEWIQVFWnNGZudEz6h4wApKRvagNVmv4U2mgpAPUrnsNB0Nx+N2GMCoyQNJVdUYnl0vdK2EFnmqfBweUBwoemcTsjKDrFs9m8/v9XtClyvJ8PqOqoizaxZv1Zjad0QwoO/biBldhwV/d4E+4ZIpFx5dpGQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <picture>\n        <source\n          srcset=\"/static/certbot-help-output-ubuntu-ecf9876f6711e42e12ccca556603cdd5-ffa36.webp 256w,\n/static/certbot-help-output-ubuntu-ecf9876f6711e42e12ccca556603cdd5-5baa5.webp 512w,\n/static/certbot-help-output-ubuntu-ecf9876f6711e42e12ccca556603cdd5-d0536.webp 575w\"\n          sizes=\"(max-width: 575px) 100vw, 575px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/certbot-help-output-ubuntu-ecf9876f6711e42e12ccca556603cdd5-62252.png 256w,\n/static/certbot-help-output-ubuntu-ecf9876f6711e42e12ccca556603cdd5-c5dcc.png 512w,\n/static/certbot-help-output-ubuntu-ecf9876f6711e42e12ccca556603cdd5-2f382.png 575w\"\n          sizes=\"(max-width: 575px) 100vw, 575px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n          src=\"/static/certbot-help-output-ubuntu-ecf9876f6711e42e12ccca556603cdd5-2f382.png\"\n          alt=\"Certbot help output\"\n          title=\"\"\n          src=\"/static/certbot-help-output-ubuntu-ecf9876f6711e42e12ccca556603cdd5-2f382.png\"\n        />\n      </picture>\n      </span>\n  </span>\n  </p>\n<h2 id=\"generating-a-certificate-with-certbot\"><a href=\"#generating-a-certificate-with-certbot\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generating a certificate with Certbot</h2>\n<p>Certbot uses Let‚Äôs Encrypt to generate a certificate. Let‚Äôs encrypt issues a certificate for your domain only if able to verify that you really own that domain and that it is associated with the public IP of the machine from which you are running certbot.</p>\n<p>So, in order to pass the verification process, you need to have a web server running on your machine and accessible from the outside world. While Certbot supports the main web servers such as <a href=\"/tag/nginx/\">Nginx</a> and Apache, it also features a standalone server that you can use exclusively for the verification process. This web server will run on the standard web ports (80 and 443), so if you have other services using these ports you need to stop them first.</p>\n<p>In the case of OpenVPN you can stop its web server with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">service</span> openvpnas stop</code></pre></div>\n<p>Then you can run certbot command line with the following options:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> certbot certonly \\\n  --standalone \\\n  --non-interactive \\\n  --agree-tos \\\n  --email YOUR_CERTIFICATE_EMAIL \\\n  --domains YOUR_DOMAIN \\\n  --pre-hook <span class=\"token string\">'sudo service openvpnas stop'</span> \\\n  --post-hook <span class=\"token string\">'sudo service openvpnas start'</span></code></pre></div>\n<p>Let‚Äôs see briefly what every option is doing:</p>\n<ul>\n<li><code class=\"language-text\">--standalone</code>: runs the standalone web server for the verification process.</li>\n<li><code class=\"language-text\">--non-interactive</code>: runs in totally automated mode, never asks for input.</li>\n<li><code class=\"language-text\">--agree-tos</code>: needed to make the above work, with this parameter you are confirming you agree to the terms of service.</li>\n<li><code class=\"language-text\">--email</code>: the certificate email.</li>\n<li><code class=\"language-text\">--domains</code>: the certificate domain.</li>\n<li><code class=\"language-text\">--pre-hook</code>: this is needed for the auto-renewal of the certificate and describes what is the command to run before the renewal process can be executed. We are using it to stop the OpenVPN web interface.</li>\n<li><code class=\"language-text\">--post-hook</code>: similar to the previous one, allows us to specify a command to be executed after a certificate is renewed, we use it to restart the OpenVPN web interface.</li>\n</ul>\n<p>This command generates numerous files including <code class=\"language-text\">server.crt</code> and <code class=\"language-text\">server.key</code>, the two files we need to use in OpenVPN. So let‚Äôs link them into the proper OpenVPN folder:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> -s -f /etc/letsencrypt/live/YOUR_DOMAIN/cert.pem /usr/local/openvpn_as/etc/web-ssl/server.crt\n<span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> -s -f /etc/letsencrypt/live/YOUR_DOMAIN/privkey.pem /usr/local/openvpn_as/etc/web-ssl/server.key</code></pre></div>\n<p>We link them because they will be changed in the future by the renewal process, so we are sure that OpenVPN will be always using the most updated certificate files.</p>\n<p>And, finally, we can restart OpenVPN:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">sudo</span> <span class=\"token function\">service</span> openvpnas start</code></pre></div>\n<p>After few seconds your OpenVPN website should be up and running, and with a shiny green icon indicating that the website is properly encrypted through a signed certificate, woohoo, well done!</p>\n<h2 id=\"a-complete-example-infrastructure-with-terraform\"><a href=\"#a-complete-example-infrastructure-with-terraform\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A complete example infrastructure with Terraform</h2>\n<p>I am happy to share with you a simplified version of my Terraform OpenVPN project, to give you an example of how you can use the aforementioned details in a Terraform context.</p>\n<p>All the code available in the following section is also available as a <a href=\"https://github.com/lmammino/terraform-openvpn\">repository on GitHub</a>.</p>\n<p>Let‚Äôs start with a list of the AWS resources we need in order to provision a fully functional OpenVPN:</p>\n<ul>\n<li>A <strong>VPC</strong> (Virtual Private Cloud)</li>\n<li>One or more <strong>subnets</strong> in the VPC</li>\n<li>A <strong>EC2 instance</strong> to host OpenVPN</li>\n<li>A <strong>key pair</strong> to be able to SSH into the OpenVPN machine (for maintenance or troubleshooting)</li>\n<li>A <strong>security group</strong> (to enable traffic inside and outside the EC2 instance)</li>\n<li>A <strong>DNS record</strong> in Route53 to expose our VPN in a subdomain</li>\n</ul>\n<p>Quite a few things to be honest, but the declarative nature of Terraform will make things easy.</p>\n<p>Let‚Äôs create a file called <code class=\"language-text\">openvpn.tf</code> and let‚Äôs start to add things there:</p>\n<h3 id=\"vpc--subnet\"><a href=\"#vpc--subnet\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VPC &#x26; Subnet</h3>\n<p>Let‚Äôs create the VPC and the subnet:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">variable &quot;vpc_cidr_block&quot; {\n  default = &quot;10.0.0.0/16&quot;\n}\n\nvariable &quot;subnet_cidr_block&quot; {\n  default = &quot;10.0.0.0/16&quot;\n}\n\nresource &quot;aws_vpc&quot; &quot;main&quot; {\n  cidr_block = &quot;${var.vpc_cidr_block}&quot;\n}\n\nresource &quot;aws_subnet&quot; &quot;vpn_subnet&quot; {\n  vpc_id     = &quot;${aws_vpc.main.id}&quot;\n  cidr_block = &quot;${var.subnet_cidr_block}&quot;\n}</code></pre></div>\n<p>Here we are using two variables <code class=\"language-text\">vpc_cidr_block</code> and <code class=\"language-text\">subnet_cidr_block</code> that can be easily reassigned from the outside to change the configuration if needed. By default, we are creating a VPC on the <code class=\"language-text\">10.0.0.0/16</code> IP range and a subnet spawning over the full VPN (same IP range).</p>\n<p>The rest of the code describing the VPC and the Subnet resources should be pretty self-explanatory.</p>\n<h3 id=\"the-key-pair\"><a href=\"#the-key-pair\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The key pair</h3>\n<p>Let‚Äôs create now the SSH key that we can use later in case we want to SSH into the OpenVPN machine.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">variable &quot;public_key&quot; {}\n\nresource &quot;aws_key_pair&quot; &quot;openvpn&quot; {\n  key_name   = &quot;openvpn-key&quot;\n  public_key = &quot;${var.public_key}&quot;\n}</code></pre></div>\n<p>Basically we are only defining here a <code class=\"language-text\">aws_key_pair</code> resource and specifying a name and the public key.</p>\n<p>Public key is a string that comes from the variable <code class=\"language-text\">public_key</code>.</p>\n<p>Most of the time you will be creating a dedicated key with the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">ssh-keygen -f openvpn.key</code></pre></div>\n<p>this will create <code class=\"language-text\">openvpn.key</code> (private key) and <code class=\"language-text\">openvpn.key.pub</code> (public key). The first one is the one we would reference here.</p>\n<p>If we want to reference the content of a file we can use <code class=\"language-text\">&quot;${file(&quot;openvpn.key.pub&quot;)}&quot;</code> to assign a terraform variable.</p>\n<h3 id=\"security-group\"><a href=\"#security-group\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Security group</h3>\n<p>Let‚Äôs create our security group:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">variable &quot;ssh_port&quot; {\n  default = 22\n}\n\nvariable &quot;ssh_cidr&quot; {\n  default = &quot;0.0.0.0/0&quot;\n}\n\nvariable &quot;https_port&quot; {\n  default = 443\n}\n\nvariable &quot;https_cidr&quot; {\n  default = &quot;0.0.0.0/0&quot;\n}\n\nvariable &quot;tcp_port&quot; {\n  default = 943\n}\n\nvariable &quot;tcp_cidr&quot; {\n  default = &quot;0.0.0.0/0&quot;\n}\n\nvariable &quot;udp_port&quot; {\n  default = 1194\n}\n\nvariable &quot;udp_cidr&quot; {\n  default = &quot;0.0.0.0/0&quot;\n}\n\nresource &quot;aws_security_group&quot; &quot;openvpn&quot; {\n  name        = &quot;openvpn_sg&quot;\n  description = &quot;Allow traffic needed by openvpn&quot;\n  vpc_id      = &quot;${aws_vpc.main.id}&quot;\n\n  // ssh\n  ingress {\n    from_port   = &quot;${var.ssh_port}&quot;\n    to_port     = &quot;${var.ssh_port}&quot;\n    protocol    = &quot;tcp&quot;\n    cidr_blocks = [&quot;${var.ssh_cidr}&quot;]\n  }\n\n  // https\n  ingress {\n    from_port   = &quot;${var.https_port}&quot;\n    to_port     = &quot;${var.https_port}&quot;\n    protocol    = &quot;tcp&quot;\n    cidr_blocks = [&quot;${var.https_cidr}&quot;]\n  }\n\n  // open vpn tcp\n  ingress {\n    from_port   = &quot;${var.tcp_port}&quot;\n    to_port     = &quot;${var.tcp_port}&quot;\n    protocol    = &quot;tcp&quot;\n    cidr_blocks = [&quot;${var.tcp_cidr}&quot;]\n  }\n\n  // open vpn udp\n  ingress {\n    from_port   = &quot;${var.udp_port}&quot;\n    to_port     = &quot;${var.udp_port}&quot;\n    protocol    = &quot;udp&quot;\n    cidr_blocks = [&quot;${var.udp_cidr}&quot;]\n  }\n\n  // all outbound traffic\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = &quot;-1&quot;\n    cidr_blocks = [&quot;0.0.0.0/0&quot;]\n  }\n}</code></pre></div>\n<p>By default, this Security group allows access from every IP address using the ports 22 (SSH), 433 (HTTPS) and all outside traffic. It also enables the traffic needed for the OpenVPN protocol both on TCP (port 943) and UDP (port 1194).\nIn case you want a custom setup, you can redefine all the relevant variables here (but in that case you might need to customise also the OpenVPN settings, a step which is not covered in this article).</p>\n<h3 id=\"subdomain\"><a href=\"#subdomain\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Subdomain</h3>\n<p>Let‚Äôs now create the subdomain from where our VPN will be accessible.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">variable &quot;route53_zone_name&quot; {}\nvariable &quot;subdomain_name&quot; {}\n\nvariable &quot;subdomain_ttl&quot; {\n  default = &quot;60&quot;\n}\n\ndata &quot;aws_route53_zone&quot; &quot;main&quot; {\n  name = &quot;${var.route53_zone_name}&quot;\n}\n\nresource &quot;aws_route53_record&quot; &quot;vpn&quot; {\n  zone_id = &quot;${data.aws_route53_zone.main.zone_id}&quot;\n  name    = &quot;${var.subdomain_name}&quot;\n  type    = &quot;A&quot;\n  ttl     = &quot;${var.subdomain_ttl}&quot;\n  records = [&quot;${aws_instance.openvpn.public_ip}&quot;]\n}</code></pre></div>\n<p>In this part of the code, we are defining 3 variables:</p>\n<ul>\n<li><code class=\"language-text\">route53_zone_name</code>: the name of your main domain zone (e.g. ‚Äúexample.com.‚Äù, notice the dot at the end).</li>\n<li><code class=\"language-text\">subdomain_name</code>: the name of the subdomain to use for the VPN (e.g. ‚Äúvpn.example.com‚Äù).</li>\n<li><code class=\"language-text\">subdomain_ttl</code>: the TTL for the domain (60 seconds by default).</li>\n</ul>\n<p>Then, we create a reference to the Route53 zone using the <code class=\"language-text\">data</code> syntax.</p>\n<p>Finally, we create the record in the zone using an <code class=\"language-text\">aws_route53_record</code> resource.</p>\n<p>Notice that we are referencing here the EC2 instance public IP, which we haven‚Äôt defined yet.</p>\n<h3 id=\"ec2-instance\"><a href=\"#ec2-instance\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>EC2 instance</h3>\n<p>Let‚Äôs see now how we can define the EC2 instance that will host the OpenVPN software for our virtual private cloud:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">variable &quot;ami&quot; {\n  default = &quot;ami-f53d7386&quot; // ubuntu xenial openvpn ami in eu-west-1\n}\n\nvariable &quot;instance_type&quot; {\n  default = &quot;t2.medium&quot;\n}\n\nvariable &quot;admin_user&quot; {\n  default = &quot;openvpn&quot;\n}\n\nvariable &quot;admin_password&quot; {\n  default = &quot;openvpn&quot;\n}\n\nresource &quot;aws_instance&quot; &quot;openvpn&quot; {\n  tags {\n    Name = &quot;openvpn&quot;\n  }\n\n  ami                         = &quot;${var.ami}&quot;\n  instance_type               = &quot;${var.instance_type}&quot;\n  key_name                    = &quot;${aws_key_pair.openvpn.key_name}&quot;\n  subnet_id                   = &quot;${aws_subnet.vpn_subnet.id}&quot;\n  vpc_security_group_ids      = [&quot;${aws_security_group.openvpn.id}&quot;]\n  associate_public_ip_address = true\n\n  # `admin_user` and `admin_pw` need to be passed in to the appliance through `user_data`, see docs --&gt;\n  # https://docs.openvpn.net/how-to-tutorialsguides/virtual-platforms/amazon-ec2-appliance-ami-quick-start-guide/\n  user_data = &lt;&lt;USERDATA\nadmin_user=${var.admin_user}\nadmin_pw=${var.admin_password}\nUSERDATA\n}</code></pre></div>\n<p>In this piece of code we are defining some variables:</p>\n<ul>\n<li><code class=\"language-text\">ami</code>: the id of the AMI (Amazon Machine Image) to use to run the EC2 instance. The default one is a Ubuntu Xenial OpenVPN machine that runs on the eu-west-1 region (Ireland). Feel free to <a href=\"https://cloud-images.ubuntu.com/locator/ec2/\">select another image</a> that might suit your needs best.</li>\n<li><code class=\"language-text\">instance_type</code>: the type of instance. You can check the <a href=\"https://aws.amazon.com/ec2/instance-types/\">list of all the type of EC2 instances</a> to understand which one might be the best for you. The default here is ok for most of the use cases.</li>\n<li><code class=\"language-text\">admin_user</code>, <code class=\"language-text\">admin_password</code>: The username and password of the admin user for your VPN.</li>\n</ul>\n<p>Whit all those variable in place, we can describe a <code class=\"language-text\">aws_instance</code> resource. Notice that we are defining it so that it will be bootstrapped in our VPC and in the subnet we specified before. Also notice that we are setting <code class=\"language-text\">associate_public_ip_address</code> to <code class=\"language-text\">true</code>, this way the machine will get a public IP (the one we will associate to the subdomain defined earlier).</p>\n<p>Finally we define a <code class=\"language-text\">user_data</code> property. <a href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html#instancedata-add-user-data\">EC2 User Data</a> allows to provide extra configuration code that is executed as soon as the machine is bootstrapped. It is generally used to install extra software, start some service or edit configuration values. In our case, since our image already contains OpenVPN, we use it only to provide the credentials for the default OpenVPN admin user.</p>\n<h3 id=\"trigger-based-provisioning-with-code-classlanguage-textnull_resourcecode\"><a href=\"#trigger-based-provisioning-with-code-classlanguage-textnull_resourcecode\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Trigger-based provisioning with <code class=\"language-text\">null_resource</code></h3>\n<p>At this point we created all the resources we need and the OpenVPN admin can be already accessed by pointing the browser to your custom subdomain (using the HTTPS protocol).</p>\n<p>If you try to do that though, you will get a warning page saying that the certificate for this domain is not valid. This is because OpenVPN is using an auto-generated self-signed certificate which is not bound to your domain, neither signed by a trusted authority (such as Let‚Äôs Encrypt).</p>\n<p>So let‚Äôs do the interesting bit here, adding a Let‚Äôs Encrypt certificate for our subdomain!</p>\n<p>If you got the basics of Terraform and AWS here you might think that we can do this by simply adding few lines to our EC2 User Data script. While this, in theory, is not wrong, is not going to work in this case because of the way our resources here depend on each other. Let‚Äôs clarify exactly why‚Ä¶</p>\n<p>So in our current situation, we have to respect the following order of creating resources:</p>\n<ol>\n<li>Create a VPC</li>\n<li>Create a Subnet in the VPC</li>\n<li>Create a key pair and a security group</li>\n<li>Create an EC2 instance</li>\n<li>Create a subdomain record pointing to the public address of the EC2 instance</li>\n<li>(TODO) Create the certificate and install into the current OpenVPN instance</li>\n</ol>\n<p>So, the subdomain record can be created only after the EC2 instance is running and it has got a public IP address, only then we have a valid domain that we can use for the certificate. This means we cannot use the EC2 provisioning step, but we need to have a ‚Äútrigger‚Äù that tells us when the subdomain is available and do some extra stuff.</p>\n<p>Terraform is smart enough to reconstruct the dependency graph of all our resources and to create the resources in the right order, so we don‚Äôt need to worry about that and we can keep loving the declarative style of its syntax.</p>\n<p>This means that the only thing left to do is to specify this trigger, which we can do by using a <a href=\"https://www.terraform.io/docs/provisioners/null_resource.html\"><code class=\"language-text\">null_resource</code></a>.</p>\n<p>Quoting the official documentation:</p>\n<blockquote>\n<p>The <code class=\"language-text\">null_resource</code> is a resource that allows you to configure provisioners that are not directly associated with a single existing resource.</p>\n</blockquote>\n<p>Let‚Äôs jump straight into the code, which I believe will make everything clear:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">variable &quot;certificate_email&quot; {}\n\nresource &quot;null_resource&quot; &quot;provision_openvpn&quot; {\n  triggers {\n    subdomain_id = &quot;${aws_route53_record.vpn.id}&quot;\n  }\n\n  connection {\n    type        = &quot;ssh&quot;\n    host        = &quot;${aws_instance.openvpn.public_ip}&quot;\n    user        = &quot;${var.ssh_user}&quot;\n    private_key = &quot;${var.private_key}&quot;\n    agent       = false\n  }\n\n  provisioner &quot;remote-exec&quot; {\n    inline = [\n      &quot;sudo apt-get install -y curl vim libltdl7 python3 python3-pip python software-properties-common unattended-upgrades&quot;,\n      &quot;sudo add-apt-repository -y ppa:certbot/certbot&quot;,\n      &quot;sudo apt-get -y update&quot;,\n      &quot;sudo apt-get -y install python-certbot certbot&quot;,\n      &quot;sudo service openvpnas stop&quot;,\n      &quot;sudo certbot certonly --standalone --non-interactive --agree-tos --email ${var.certificate_email} --domains ${var.subdomain_name} --pre-hook &#39;service openvpnas stop&#39; --post-hook &#39;service openvpnas start&#39;&quot;,\n      &quot;sudo ln -s -f /etc/letsencrypt/live/${var.subdomain_name}/cert.pem /usr/local/openvpn_as/etc/web-ssl/server.crt&quot;,\n      &quot;sudo ln -s -f /etc/letsencrypt/live/${var.subdomain_name}/privkey.pem /usr/local/openvpn_as/etc/web-ssl/server.key&quot;,\n      &quot;sudo service openvpnas start&quot;,\n    ]\n  }\n}</code></pre></div>\n<p>As you can see at the very top of this snippet of code, we are declaring a <code class=\"language-text\">null_resource</code> that is triggered when the value <code class=\"language-text\">aws_route53_record.vpn.id</code> changes, which happens when the subdomain is created. When this happens, Terraform will execute the provisioning logic defined in the rest of the code here, which essentially describes to Terraform how to connect to the OpenVPN machine and what code needs to be run and which we already discussed in the first part of this article.</p>\n<h3 id=\"the-provider-configuration-and-the-variable-file\"><a href=\"#the-provider-configuration-and-the-variable-file\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The provider configuration and the variable file</h3>\n<p>Ok, our setup is almost ready‚Ä¶ The only two things we have left to do are:</p>\n<ul>\n<li>define the needed configuration to connect to our AWS account;</li>\n<li>define some values for our configuration before we can run Terraform.</li>\n</ul>\n<p>To define the AWS config we need to specify the following terraform code (I generally do that into a dedicated file called <code class=\"language-text\">provider.tf</code>, but you can write this in any terraform file in your project):</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">variable &quot;aws_profile_name&quot; {}\nvariable &quot;aws_region&quot; {}\n\nprovider &quot;aws&quot; {\n  profile = &quot;${var.aws_profile_name}&quot;\n  region  = &quot;${var.aws_region}&quot;\n}</code></pre></div>\n<p>Finally we can define the values for our variables. To do so we need to create a file called <code class=\"language-text\">terraform.tfvars</code> which contains a simple list of key-value pairs:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\">aws_profile_name = &quot;default&quot;\naws_region = &quot;eu-west-1&quot;\npublic_key = &quot;${file(&quot;key.pub&quot;)}&quot;\nprivate_key = &quot;${file(&quot;key&quot;)}&quot;\ncertificate_email = &quot;tech@example.com&quot;\nroute53_zone_name = &quot;example.com.&quot;\nsubdomain_name = &quot;vpn.example.com&quot;\n\n# vpc_cidr_block = &quot;10.0.0.0/16&quot;\n# subnet_cidr_block = &quot;10.0.0.0/16&quot;\n# ssh_port = 22\n# ssh_cidr = &quot;0.0.0.0/0&quot;\n# https_port = 443\n# https_cidr = &quot;0.0.0.0/0&quot;\n# tcp_port = 943\n# tcp_cidr = &quot;0.0.0.0/0&quot;\n# udp_port = 1194\n# udp_cidr = &quot;0.0.0.0/0&quot;\n# subdomain_ttl = 60\n# ami = &quot;ami-f53d7386&quot;\n# instance_type = &quot;t2.medium&quot;\n# admin_user = &quot;openvpn&quot;\n# admin_password = &quot;openvpn&quot;</code></pre></div>\n<p>The commented lines (starting with <code class=\"language-text\">#</code>) are left for your own reference, in case you want to change one of the configuration defaults.</p>\n<h3 id=\"plan-apply-and-destroy\"><a href=\"#plan-apply-and-destroy\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Plan, apply and destroy</h3>\n<p>Ok, we are finally ready to run our Terraform project.</p>\n<p>In order to see what changes will be applied to your AWS account, your will need to run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform plan</code></pre></div>\n<p>If you are happy with the displayed changes you can confirm them with:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform apply</code></pre></div>\n<p>After few minutes you will have a fully provisioned Virtual Private Cloud with its own VPN access. Try to connect to the domain (<a href=\"https://vpn.example.com\">https://vpn.example.com</a>) and login in with your admin username and password!</p>\n<p>Ok, this was probably just a test project for you so you might fancy cleaning everything up‚Ä¶ No problem, just run:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform destroy</code></pre></div>\n<p>and everything we just created will be blown away from your AWS account, leaving no trace behind!</p>\n<h2 id=\"some-extra-tips\"><a href=\"#some-extra-tips\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Some extra tips</h2>\n<p>Just few extra tips before closing off‚Ä¶</p>\n<h3 id=\"lets-encrypt-throttling\"><a href=\"#lets-encrypt-throttling\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Let‚Äôs Encrypt throttling</h3>\n<p>Let‚Äôs Encrypt allows you to generate a <strong>limited number of certificates for a given domain on a given timespan</strong>.</p>\n<p>Quoting directly from <a href=\"https://letsencrypt.org/docs/rate-limits/\">the Let‚Äôs Encrypt Rate Limit documentation</a>:</p>\n<blockquote>\n<p>The main limit is <strong>Certificates per Registered Domain (20 per week)</strong>. A registered domain is, generally speaking, the part of the domain you purchased from your domain name registrar. For instance, in the name www.example.com, the registered domain is example.com. In new.blog.example.co.uk, the registered domain is example.co.uk. We use the Public Suffix List to calculate the registered domain.</p>\n<p>If you have a lot of subdomains, you may want to combine them into a single certificate, up to a limit of 100 Names per Certificate. Combined with the above limit, that means you can issue certificates containing up to <strong>2,000 unique subdomains per week</strong>. A certificate with multiple names is often called a SAN certificate, or sometimes a UCC certificate.</p>\n<p>We also have a <strong>Duplicate Certificate limit of 5 certificates per week</strong>. A certificate is considered a duplicate of an earlier certificate if they contain the exact same set of hostnames, ignoring capitalization and ordering of hostnames. For instance, if you requested a certificate for the names [www.example.com, example.com], you could request four more certificates for [www.example.com, example.com] during the week. If you changed the set of names by adding [blog.example.com], you would be able to request additional certificates.</p>\n</blockquote>\n<p>So, be careful not to blow your production domain while playing with Terraform (or with certbot in general).</p>\n<p>There are options to generate <em>test</em> or <em>staging</em> certificates, although I haven‚Äôt experimented much with them, so I can only suggest you to have a look at the documentation illustration all the <a href=\"https://certbot.eff.org/docs/using.html#certbot-command-line-options\">available command line options</a>.</p>\n<p>Huge thanks to <a href=\"https://www.reddit.com/user/tialaramex\">tialaramex</a> on Reddit for <a href=\"https://www.reddit.com/r/linuxadmin/comments/6ia1wx/use_certbot_to_automate_the_creation_of_ssl/dj57zlw/\">a fruitful discussion</a> and few pieces of advice about this specific aspect.</p>\n<h3 id=\"certificate-expiry-and-renewal\"><a href=\"#certificate-expiry-and-renewal\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Certificate expiry and renewal</h3>\n<p>Let‚Äôs Encrypt <strong>certificates expire after 3 months</strong>, so be sure you enable the auto renewal feature.</p>\n<p>In reality, the feature is enabled by default, so what‚Äôs left to do is to test the auto renewal process. With certbot you can do that using the following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">certbot renew --dry-run</code></pre></div>\n<p>There‚Äôs another important point here to take into account here: everytime the certificate renewal procedure is triggered, your VPN service gets shutdown for few seconds and all the currently connected users are disconnected.</p>\n<p>This will happen only once every 2-3 months, but if it‚Äôs a real struggle for your organisation you might want to explore different setups.</p>\n<p>One solution could be to setup a reverse proxy like Nginx and use it for the SSL termination. This way during the renewal you will only shutdown nginx and not the full VPN service.</p>\n<p>Thanks again to <a href=\"https://www.reddit.com/user/tialaramex\">tialaramex</a> on Reddit for raising this discussion and proposing the reverse proxy solution.</p>\n<h3 id=\"intermittent-failures-during-the-provisioning\"><a href=\"#intermittent-failures-during-the-provisioning\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intermittent failures during the provisioning</h3>\n<p>I had some problems during the installation of certbot on the image used here by default. If this is happening to you as well, you should be able to sort them out by running an <code class=\"language-text\">apt-get upgrade</code> before trying to install certbot. Since you want to do that in an automated fashion, you‚Äôll probably need a more sophisticated command that takes care of auto-responding to possible prompts: <code class=\"language-text\">yes | sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade</code>.</p>\n<h2 id=\"wrapping-up\"><a href=\"#wrapping-up\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Wrapping up</h2>\n<p>This is just a quick example focused on OpenVPN, but you can use the same approach to generate certificates for other web applications. Consult the <a href=\"https://certbot.eff.org/docs/\">Certbot documentation </a> to see all the supported web servers and how to use Certbot with them.</p>\n<p>Also, I hope this tutorial gave you a good idea on how to use Terraform to automate your infrastructure provisioning. I am still a bit of noob with it, so if you see I have done something terribly wrong (or something that can be improved), please let me know in the comments.</p>\n<p>Thanks to <a href=\"https://twitter.com/Podgeypoos79\">@Podgeypoos79</a>, <a href=\"https://twitter.com/tech_fort\">@techfort</a>, <em>Alan</em> and the rest of Planet 9 tech team for working with me on this cool üí© (chocolate ice cream!). Also a huge thanks to my friend <a href=\"https://twitter.com/gianarb\">@gianarb</a> for some precious <em>devopsy</em> bits of advice.</p>\n<p>Let me know in the comments if this article was useful for you and if you integrated something similar in one of your projects!</p>\n<p>See you in the next post :)</p>","frontmatter":{"title":"Using Let‚Äôs Encrypt and Certbot to automate the creation of certificates for OpenVPN","meta_description":"This article illustrates you how to use Certbot to automate the creation of SSL certificates for OpenVPN and how to release on AWS using Terraform.","slug":"using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn","author":"Luciano Mammino","tags":["ssl","web","terraform","security","aws"],"date":"June 19, 2017","dateISO":"2017-06-19T22:00:20.000Z","header_img":{"publicURL":"/static/using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn-loige-icover-image-45dfcbcf12ab7cac8a20f867207af385.jpg"},"fb_img":{"publicURL":"/static/using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn-fb-4d7bb40a4b4dcdc66fe27daa79bd36bf.png"},"tw_img":{"publicURL":"/static/using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn-tw-f425f3fa6df54e1bf300a94fcdd1bf4c.png"}}}},"pageContext":{"tags":["ssl","web","terraform","security","aws"],"slug":"using-lets-encrypt-and-certbot-to-automate-the-creation-of-certificates-for-openvpn","previous":{"timeToRead":2,"excerpt":"This June, I had an amazing experience talking again about Serverless and how we use it at  Planet 9 Energy  at the recent  Shift Conference  in Split, Croatia. In my talk titled ‚Äù Serverless: The pros and cons of building a company\nwithout infrastructure ‚Äù, I tried to address what Serverless is and why is becoming such a big thing, also exploring what I believe are the pros and cons of this new paradigm. The experience was great and I was super happy to have a chance to share the stage with extraordinary‚Ä¶","fields":{"slug":"my-serverless-talk-at-shift-conference-in-split"},"frontmatter":{"date":"15 June, 2017","title":"My Serverless talk at Shift conference in Split","tags":["conferences","slides","speaking","serverless","javascript","node-js"],"header_img":{"publicURL":"/static/my-serverless-talk-at-shift-conference-in-split-cover-picture-ea5bb4fdb59eb7d14eb0a6b5a7e64465.jpg"}}},"next":{"timeToRead":12,"excerpt":"Lately, I tried to understand why modern cloud computing brought us to the idea (and growing adoption) of ‚ÄúServerless‚Äù. In this article, I will illustrate the result of a small research I did about the history of Cloud computing from the age of  bare metal  to  serverless . ‚ÄúYou have to know the past to understand the present.‚Äù ‚Äï Carl Sagan At the end of this article, I will also illustrate a definition of Serverless and what are its main characteristics. The invention of the web This story starts with  Sir‚Ä¶","fields":{"slug":"from-bare-metal-to-serverless"},"frontmatter":{"date":"16 December, 2017","title":"From bare metal to Serverless","tags":["serverless","aws"],"header_img":{"publicURL":"/static/from-bare-metal-to-serverless-luciano-mammino-loige-co-917e1c27c76ede42e7c2693844bd6898.jpg"}}},"similar":[{"slug":"aws-solution-architect-associate-exam-notes-tips","title":"AWS Solution Architect Associate exam, my notes and tips","publishedAt":"21 October, 2018","score":1},{"slug":"aws-command-line-s3-content-from-stdin-or-to-stdout","title":"AWS Command line: S3 content from stdin or to stdout","publishedAt":"05 May, 2018","score":1},{"slug":"from-bare-metal-to-serverless","title":"From bare metal to Serverless","publishedAt":"16 December, 2017","score":1},{"slug":"8-invitations-to-try-keybase-io","title":"8 invitations to try Keybase.io","publishedAt":"26 May, 2015","score":1},{"slug":"reset-your-mysql-server-password","title":"Reset your MySql server password","publishedAt":"30 March, 2014","score":1}]}}